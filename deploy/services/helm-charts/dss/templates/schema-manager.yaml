{{- $image := .Values.dss.image }}
{{- $datastoreHost :=  (include "datastoreHost" .) -}}
{{- $datastorePort :=  (include "datastorePort" .) -}}
{{- $datastoreUser :=  (include "datastoreUser" .) -}}
{{- $jobVersion := .Release.Revision -}} {{/* Jobs template definition is immutable, using the revision in the name forces the job to be recreated at each helm upgrade. */}}

{{- $rid_crdb := .Files.Get "version/crdb/rid.version" | quote }}
{{- $scd_crdb := .Files.Get "version/crdb/scd.version" | quote }}
{{- $aux_crdb := .Files.Get "version/crdb/aux.version" | quote }}

{{- $waitForDatastore := include "init-container-wait-for-http" (dict "serviceName" "cockroachdb" "url" (printf "http://%s:8080/health" $datastoreHost)) -}}
{{- $schemas := dict "rid" $rid_crdb "scd" $scd_crdb "aux_" $aux_crdb }}

{{- if .Values.yugabyte.enabled }}
{{- $rid_yugabyte := .Files.Get "version/yugabyte/rid.version" | quote }}
{{- $scd_yugabyte := .Files.Get "version/yugabyte/scd.version" | quote }}
{{- $aux_yugabyte := .Files.Get "version/yugabyte/aux.version" | quote }}
{{- $waitForDatastore = include "init-container-wait-for-http" (dict "serviceName" "yb-tserver" "url" (printf "http://%s:9000/status" $datastoreHost)) -}}
{{- $schemas = dict "rid" $rid_yugabyte "scd" $scd_yugabyte "aux_" $aux_yugabyte }}
{{- end -}}

{{- range $service, $schemaVersion := $schemas }}
{{- $serviceClean := $service | replace "_" "" }}
---
apiVersion: batch/v1
kind: Job
metadata:
  labels:
    name: {{ $serviceClean }}-schema-manager-{{$jobVersion}}
  name: {{ $serviceClean }}-schema-manager-{{$jobVersion}}
  namespace: default
spec:
  completions: 1
  parallelism: 1
{{/*  TODO: use selector instead of incrementing jobVersion in name to mitigate immutable template*/}}
  template:
    metadata:
      annotations:
        sidecar.istio.io/inject: "false"
      labels:
        name: {{ $serviceClean }}-schema-manager-{{$jobVersion}}
    spec:
      initContainers:
        {{- $waitForDatastore | nindent 8 }}
      containers:
        - args:
            - migrate
            - --cockroach_host={{ $datastoreHost }}
            - --cockroach_port={{ $datastorePort }}
            - --cockroach_user={{ $datastoreUser }}
{{ if $.Values.cockroachdb.enabled }}
            - --cockroach_ssl_dir=/cockroach/cockroach-certs
            - --cockroach_ssl_mode=verify-full
            - --schemas_dir=/db-schemas/{{ $service }}
{{ else }}
            - --schemas_dir=/db-schemas/yugabyte/{{ $service  }}
            - --cockroach_ssl_dir=/opt/yugabyte-certs/
            - --cockroach_ssl_mode=verify-full
{{ end }}
            - --db_version={{$schemaVersion}}
          command:
            - db-manager
            - migrate
          image: {{$image}}
          imagePullPolicy: IfNotPresent
          name: {{ $service | replace "_" "" }}-schema-manager-{{$jobVersion}}
          stdin: false
          tty: false
          volumeMounts:
            {{- include "ca-certs:volumeMount" (dict "cockroachdbEnabled" $.Values.cockroachdb.enabled ) | nindent 12 }}
            {{- include "client-certs:volumeMount" (dict "cockroachdbEnabled" $.Values.cockroachdb.enabled ) | nindent 12 }}
      imagePullSecrets: []
      restartPolicy: OnFailure
      terminationGracePeriodSeconds: 30
      volumes:
        {{- include "ca-certs:volume" (dict "cockroachdbEnabled" $.Values.cockroachdb.enabled ) | nindent 8 }}
        {{- include "client-certs:volume" (dict "cockroachdbEnabled" $.Values.cockroachdb.enabled ) | nindent 8 }}
{{- end -}}
